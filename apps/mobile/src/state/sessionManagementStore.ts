import { create } from "zustand";

export type SessionStatus = {
  id: string;
  cwd: string | null;
  model: string | null;
  lastAccess: number;
  status: "running" | "idling";
  title: string;
};

export type ProviderName = "claude" | "gemini" | "codex";

export type SessionManagementStore = {
  sessionStatuses: SessionStatus[];
  sessionId: string | null;
  provider: ProviderName;
  model: string;
  setSessionStatuses: (sessions: SessionStatus[]) => void;
  setSessionId: (sessionId: string | null) => void;
  setProvider: (provider: ProviderName) => void;
  setModel: (model: string) => void;
  upsertSessionStatus: (session: SessionStatus) => void;
  removeSessionStatus: (sessionId: string) => void;
  clearSessionStatuses: () => void;
};

const areSessionStatusesEqual = (a: SessionStatus[], b: SessionStatus[]): boolean => {
  if (a.length !== b.length) {
    return false;
  }
  for (let i = 0; i < a.length; i++) {
    const left = a[i];
    const right = b[i];
    if (
      left.id !== right.id ||
      left.cwd !== right.cwd ||
      left.model !== right.model ||
      left.lastAccess !== right.lastAccess ||
      left.status !== right.status ||
      left.title !== right.title
    ) {
      return false;
    }
  }
  return true;
};

export const useSessionManagementStore = create<SessionManagementStore>((set) => ({
  sessionStatuses: [],
  sessionId: null,
  provider: "codex",
  model: "gpt-5.1-codex-mini",
  setSessionStatuses: (sessions) =>
    set((state) => (areSessionStatusesEqual(state.sessionStatuses, sessions) ? state : { sessionStatuses: sessions })),
  setSessionId: (sessionId) => set((state) => (state.sessionId === sessionId ? state : { sessionId })),
  setProvider: (provider) => set((state) => (state.provider === provider ? state : { provider })),
  setModel: (model) => set((state) => (state.model === model ? state : { model })),
  upsertSessionStatus: (session) =>
    set((state) => {
      const next = state.sessionStatuses.filter((s) => s.id !== session.id);
      return { sessionStatuses: [session, ...next] };
    }),
  removeSessionStatus: (sessionId) =>
    set((state) => ({
      sessionStatuses: state.sessionStatuses.filter((s) => s.id !== sessionId),
    })),
  clearSessionStatuses: () => set({ sessionStatuses: [] }),
}));

export const isSessionRunning = (session: SessionStatus): boolean =>
  session.status === "running";
